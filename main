import logging
import sys
import glob
import os
import json

sys.path.append(r"/Users/denism/work/sbb_challenge")
sys.path.append(r"/Users/denism/work/sbb_challenge/utils")

from simulator.simulator import Simulator
from simulator.simulator import BlockinException
from simulator.qtable import QTable
from simulator.event import humanize_time

logger = logging.getLogger()
logger.setLevel(logging.INFO)

FORMAT = "[%(asctime)s %(filename)s:%(lineno)s - %(funcName)s ] %(message)s"
logging.basicConfig(format=FORMAT)

path = glob.glob(r"/Users/denism/work/train-schedule-optimisation-challenge-starter-kit/problem_instances/06*")[0]

qtable = QTable()

sim = Simulator(path=path, qtable=qtable)
sim.trains = sim.trains
sim.assign_limit()

i = 1

sim.wait_time = 30
sim.max_delta = 15 * 60
sim.n_state = 2
sim.n_state_avoid = 2
sim.with_connections = True

qtable.epsilon = 0.2
qtable.alpha = 0.5  # learning rate
qtable.gamma = 0.5  # discount factor
trains = list(sim.trains)
#trains = sorted(trains, key = lambda train: list(train.network.nodes["start"].out_links)[0].get_requirement().get_entry_earliest())

sim.match_trains()
sim.spiegel_anschlusse()

score = 200
n_trains = 50
while i < 2 or n_trains <= len(trains):
    try:
        sim.initialize()
        sim.free_all_resources()
        #qtable.epsilon = max(qtable.epsilon - 0.01, 0.1)
 #       sim.trains = trains[:n_trains]
        sim.run()
        # print(humanize_time(sim.min_time), humanize_time(sim.max_time))
        if n_trains >= 50:
            n_trains += 1
        else:
            n_trains += 5
        i += 1
    except BlockinException:
        n = len(sim.trains)
        n2 = len([t for t in sim.trains if t.solution.done])
        logging.info("%s: %i/%i trains" % (humanize_time(sim.current_time), n2, n))
        pass

folder = r"/Users/denism/work/train-schedule-optimisation-challenge-starter-kit/solutions"
output_path = os.path.join(folder, sim.timetable.label + "_for_submission.json")
with open(output_path, 'w') as outfile:
    json.dump([sim.create_output()], outfile)
